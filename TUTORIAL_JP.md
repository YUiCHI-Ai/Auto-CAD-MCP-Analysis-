# AutoCAD MCP サーバー チュートリアル

このチュートリアルでは、AutoCAD MCP サーバーを使用して、Claudeなどの大規模言語モデル(LLM)からAutoCADを操作する方法を段階的に説明します。実際の業務シナリオに基づいた具体的な例を通じて、システムの活用方法を学びましょう。

## 目次

1. [環境セットアップ](#環境セットアップ)
2. [基本的な図形描画](#基本的な図形描画)
3. [レイヤー管理](#レイヤー管理)
4. [図面分析](#図面分析)
5. [テキスト検索と強調表示](#テキスト検索と強調表示)
6. [データベースクエリ](#データベースクエリ)
7. [実践的なユースケース](#実践的なユースケース)
8. [高度な使用例](#高度な使用例)
9. [トラブルシューティング](#トラブルシューティング)

## 環境セットアップ

### 前提条件

- Windows PC（Windows 10/11推奨）
- AutoCAD 2018以上（COMインターフェースをサポートするバージョン）
- Python 3.10以上
- Claude Desktop（またはMCPをサポートする他のLLMインターフェース）

### インストール手順

1. リポジトリをクローンします：

```bash
git clone https://github.com/yourusername/autocad-mcp-server.git
cd autocad-mcp-server
```

2. 仮想環境を作成して有効化します：

```bash
# 仮想環境の作成
python -m venv .venv

# Windows環境での有効化
.venv\Scripts\activate

# 有効化されると、プロンプトの先頭に(.venv)が表示されます
(.venv) C:\path\to\autocad-mcp-server>
```

3. 依存パッケージをインストールします：

```bash
# 必要なパッケージをすべてインストール
pip install -r requirements.txt

# インストール状況の確認
pip list
```

インストールされる主要パッケージ:
- mcp: Model Context Protocolの実装
- pywin32: Windows COMインターフェース
- pyautocad: AutoCAD操作の簡略化
- sqlalchemy: データベースORM
- comtypes: COMインターフェースの補助

4. （オプション）実行ファイルをビルドします：

```bash
# PyInstallerを使用して単一の実行ファイルを作成
pyinstaller --onefile server.py

# ビルド完了後、dist/server.exeが生成されます
```

### Claude Desktopとの連携設定

1. Claude Desktopをインストールします（まだの場合）
   - 公式サイト: https://claude.ai/desktop からダウンロード

2. Claude Desktopの設定ファイルを編集します：
   - ファイルパス: `%APPDATA%\Claude\claude_desktop_config.json`
   - このパスは通常 `C:\Users\ユーザー名\AppData\Roaming\Claude\claude_desktop_config.json` です

3. 以下の設定を追加します（既存のJSONを壊さないよう注意）：

```json
{
  "mcpServers": {
    "autocad-mcp-server": {
      "command": "C:/path/to/your/autocad-mcp-server/dist/server.exe",
      "args": [],
      "env": {
        "PYTHONIOENCODING": "utf-8"
      }
    }
  }
}
```

4. 実行ファイルをビルドしていない場合は、Pythonスクリプトを直接実行するように設定します：

```json
{
  "mcpServers": {
    "autocad-mcp-server": {
      "command": "C:/path/to/your/autocad-mcp-server/.venv/Scripts/python.exe",
      "args": ["C:/path/to/your/autocad-mcp-server/server.py"],
      "env": {
        "PYTHONIOENCODING": "utf-8"
      }
    }
  }
}
```

5. Claude Desktopを再起動します

6. 設定が正しく行われたか確認するには、Claudeに以下のように質問します：

```
あなたが使用できるツールを教えてください
```

応答に `autocad-mcp-server` のツールが含まれていれば成功です。

## 基本的な図形描画

### 新しい図面の作成

1. AutoCADを起動します
2. Claude Desktopを開きます
3. 以下のようにClaudeに指示します：

```
新しいAutoCAD図面を作成してください
```

Claudeは`create_new_drawing`ツールを使用して新しい図面を作成します。成功すると、AutoCADに新しい図面が表示されます。

**応答例**:
```
新しいAutoCAD図面を作成しました。デフォルトテンプレートを使用しています。
これから図形の描画や編集を行うことができます。何を描画しますか？
```

### 直線の描画

以下のようにClaudeに指示します：

```
座標(0,0)から(100,100)に直線を描いてください
```

Claudeは`draw_line`ツールを使用して直線を描画します。

**応答例**:
```
座標(0,0)から(100,100)に直線を描画しました。
ハンドル: 2A3
図層: 0（デフォルト図層）
```

より複雑な例：

```
以下の座標に四角形を描いてください：
- 左下: (10,10)
- 右下: (110,10)
- 右上: (110,60)
- 左上: (10,60)
```

Claudeは4つの直線を描画して四角形を作成します。

**応答例**:
```
四角形を描画しました：
1. (10,10)から(110,10)への線（ハンドル: 2A4）
2. (110,10)から(110,60)への線（ハンドル: 2A5）
3. (110,60)から(10,60)への線（ハンドル: 2A6）
4. (10,60)から(10,10)への線（ハンドル: 2A7）

すべての線はデフォルト図層に描画されています。
```

### 円の描画

以下のようにClaudeに指示します：

```
中心座標(50,50)、半径25の円を描いてください
```

Claudeは`draw_circle`ツールを使用して円を描画します。

**応答例**:
```
中心座標(50,50)、半径25の円を描画しました。
ハンドル: 2A8
図層: 0（デフォルト図層）
```

### レイヤーを指定した描画

以下のようにClaudeに指示します：

```
"電気"というレイヤーに、中心(200,200)、半径30の円を描いてください
```

Claudeは必要に応じて新しいレイヤーを作成し、そのレイヤーに円を描画します。

**応答例**:
```
"電気"レイヤーが存在しなかったため、新しく作成しました。
"電気"レイヤーに中心座標(200,200)、半径30の円を描画しました。
ハンドル: 2A9
```

## レイヤー管理

### レイヤーの作成

以下のようにClaudeに指示します：

```
"配管"という名前の新しいレイヤーを作成してください。色を青色に設定してください。
```

Claudeはレイヤーを作成し、指定された色を設定します。

**応答例**:
```
"配管"という名前の新しいレイヤーを作成し、色を青色(5)に設定しました。
このレイヤーに図形を描画する際は、レイヤーパラメータに"配管"を指定してください。
```

### レイヤー情報の取得

以下のようにClaudeに指示します：

```
図面内のすべてのレイヤーとその情報を表示してください
```

Claudeは図面内のすべてのレイヤーとその属性（色、線種、状態など）を表示します。

**応答例**:
```
図面内のレイヤー情報:

1. レイヤー: 0
   - 色: 7 (白)
   - 線種: Continuous
   - 状態: オン、ロックなし、凍結なし

2. レイヤー: 電気
   - 色: 1 (赤)
   - 線種: Continuous
   - 状態: オン、ロックなし、凍結なし

3. レイヤー: 配管
   - 色: 5 (青)
   - 線種: Continuous
   - 状態: オン、ロックなし、凍結なし
```

## 図面分析

### 図面要素のスキャン

以下のようにClaudeに指示します：

```
現在の図面内のすべての要素をスキャンしてデータベースに保存してください
```

Claudeは`scan_all_entities`ツールを使用して図面内のすべての要素をスキャンし、データベースに保存します。

**応答例**:
```
図面内の要素をスキャンし、データベースに保存しました。

スキャン結果:
- 合計: 9個の要素
- 内訳:
  - AcDbLine: 4個
  - AcDbCircle: 2個
  - AcDbText: 0個
  - その他: 3個

すべての要素がcad_elementsテーブルに保存されました。
```

### 要素の統計情報

以下のようにClaudeに指示します：

```
図面内の要素の種類ごとの数を教えてください
```

Claudeはデータベースから要素の統計情報を取得して表示します。

**応答例**:
```
図面内の要素統計:

- 直線 (AcDbLine): 4個
- 円 (AcDbCircle): 2個
- テキスト (AcDbText): 0個
- ポリライン (AcDbPolyline): 0個
- 寸法 (AcDbDimension): 0個
- ブロック参照 (AcDbBlockReference): 3個
- その他: 0個

合計: 9個の要素
```

### 特定の要素のハイライト

以下のようにClaudeに指示します：

```
ハンドル"2A8"の要素を赤色でハイライトしてください
```

Claudeは`highlight_entity`ツールを使用して、指定されたハンドルの要素をハイライト表示します。

**応答例**:
```
ハンドル"2A8"の要素を赤色(1)でハイライトしました。
この要素は中心座標(50,50)、半径25の円です。
```

## テキスト検索と強調表示

### テキストの追加

まず、テキスト要素を追加します：

```
以下のテキストを図面に追加してください：
- 座標(30,30)に"PMC-3M-01"
- 座標(150,150)に"PMC-3M-02"
- 座標(250,50)に"設備A"
```

Claudeはテキスト要素を追加します。

**応答例**:
```
以下のテキストを図面に追加しました：

1. 座標(30,30)に"PMC-3M-01"（ハンドル: 2AA）
2. 座標(150,150)に"PMC-3M-02"（ハンドル: 2AB）
3. 座標(250,50)に"設備A"（ハンドル: 2AC）

すべてのテキストはデフォルト図層に追加されています。
```

### テキストパターンの検索

以下のようにClaudeに指示します：

```
図面内で"PMC-3M"というテキストを検索してください
```

Claudeは`count_text_patterns`ツールを使用して、指定されたテキストパターンを検索し、結果を表示します。

**応答例**:
```
図面内で"PMC-3M"というテキストが2箇所見つかりました。

詳細:
1. テキスト: 'PMC-3M-01', 図層: 0, ハンドル: 2AA
2. テキスト: 'PMC-3M-02', 図層: 0, ハンドル: 2AB

検索結果はデータベースのtext_patternsテーブルに保存されました。
```

### テキストの強調表示

以下のようにClaudeに指示します：

```
"PMC-3M"を含むすべてのテキストを黄色でハイライトしてください
```

Claudeは`highlight_text_matches`ツールを使用して、指定されたテキストパターンを含むすべてのテキスト要素をハイライト表示します。

**応答例**:
```
"PMC-3M"を含む2個のテキスト要素を黄色(2)でハイライトしました。
ハイライトされたテキスト:
- PMC-3M-01 (ハンドル: 2AA)
- PMC-3M-02 (ハンドル: 2AB)

これらのテキスト要素が見やすいように、図面表示を調整しました。
```

## データベースクエリ

### テーブル情報の取得

以下のようにClaudeに指示します：

```
データベース内のすべてのテーブルを表示してください
```

Claudeは`get_all_tables`ツールを使用して、データベース内のすべてのテーブルを表示します。

**応答例**:
```
データベース内のテーブル:
[
  "cad_elements",
  "text_patterns",
  "sqlite_sequence"
]

主要テーブル:
- cad_elements: CAD要素の情報
- text_patterns: テキストパターンの統計情報
```

### テーブル構造の表示

以下のようにClaudeに指示します：

```
cad_elementsテーブルの構造を表示してください
```

Claudeは`get_table_schema`ツールを使用して、指定されたテーブルの構造を表示します。

**応答例**:
```
cad_elementsテーブルの構造:
[
  {
    "cid": 0,
    "name": "id",
    "type": "INTEGER",
    "notnull": 0,
    "default_value": null,
    "pk": 1
  },
  {
    "cid": 1,
    "name": "handle",
    "type": "TEXT",
    "notnull": 0,
    "default_value": null,
    "pk": 0
  },
  {
    "cid": 2,
    "name": "name",
    "type": "TEXT",
    "notnull": 1,
    "default_value": null,
    "pk": 0
  },
  {
    "cid": 3,
    "name": "type",
    "type": "TEXT",
    "notnull": 1,
    "default_value": null,
    "pk": 0
  },
  {
    "cid": 4,
    "name": "layer",
    "type": "TEXT",
    "notnull": 0,
    "default_value": null,
    "pk": 0
  },
  {
    "cid": 5,
    "name": "properties",
    "type": "TEXT",
    "notnull": 0,
    "default_value": null,
    "pk": 0
  }
]
```

### カスタムクエリの実行

以下のようにClaudeに指示します：

```
"SELECT * FROM cad_elements WHERE type = 'AcDbCircle'"というSQLクエリを実行してください
```

Claudeは`execute_query`ツールを使用して、指定されたSQLクエリを実行し、結果を表示します。

**応答例**:
```
クエリ実行結果:
[
  {
    "id": 5,
    "handle": "2A8",
    "name": "Circle",
    "type": "AcDbCircle",
    "layer": "0",
    "properties": "{\"center\": [50.0, 50.0, 0.0], \"radius\": 25.0}"
  },
  {
    "id": 6,
    "handle": "2A9",
    "name": "Circle",
    "type": "AcDbCircle",
    "layer": "電気",
    "properties": "{\"center\": [200.0, 200.0, 0.0], \"radius\": 30.0}"
  }
]

2件の円要素が見つかりました。
```

### クエリ結果に基づく要素のハイライト

以下のようにClaudeに指示します：

```
半径が25より大きいすべての円を青色でハイライトしてください
```

Claudeは適切なSQLクエリを作成し、`query_and_highlight`ツールを使用して、条件に一致する要素をハイライト表示します。

**応答例**:
```
半径が25より大きい円を検索し、青色(5)でハイライトしました。

実行したクエリ:
"SELECT handle FROM cad_elements WHERE type = 'AcDbCircle' AND json_extract(properties, '$.radius') > 25"

ハイライトされた要素:
- ハンドル "2A9": 中心(200,200)、半径30の円

合計1個の要素がハイライトされました。
```

## 実践的なユースケース

### ユースケース1: 配管図の作成

以下のようにClaudeに指示します：

```
配管図を作成したいです。以下の要素を含めてください：
1. "配管"レイヤーに、座標(100,100)から(300,100)に直線を描く
2. 座標(100,100)と(300,100)に半径10の円を描く
3. 各円の近くに"バルブ1"と"バルブ2"というテキストを追加する
```

Claudeは複数のツールを組み合わせて、要求された配管図を作成します。

**応答例**:
```
配管図を作成しました：

1. "配管"レイヤーに座標(100,100)から(300,100)への直線を描画しました（ハンドル: 2AD）

2. "配管"レイヤーに以下の円を描画しました：
   - 座標(100,100)に半径10の円（ハンドル: 2AE）
   - 座標(300,100)に半径10の円（ハンドル: 2AF）

3. 以下のテキストを追加しました：
   - 座標(90,120)に"バルブ1"（ハンドル: 2B0）
   - 座標(290,120)に"バルブ2"（ハンドル: 2B1）

すべての要素は"配管"レイヤーに作成され、青色で表示されています。
```

### ユースケース2: 図面分析とレポート作成

以下のようにClaudeに指示します：

```
現在の図面を分析して、以下の情報を含むレポートを作成してください：
1. 図面内の要素の種類と数
2. "PMC"で始まるすべてのテキスト要素のリスト
3. 各レイヤーに含まれる要素の数
```

Claudeは複数のツールを使用して図面を分析し、要求されたレポートを作成します。

**応答例**:
```
# 図面分析レポート

## 1. 要素の種類と数
- 直線 (AcDbLine): 5個
- 円 (AcDbCircle): 4個
- テキスト (AcDbText): 5個
- ブロック参照 (AcDbBlockReference): 3個
- その他: 0個
- 合計: 17個の要素

## 2. "PMC"で始まるテキスト要素
1. "PMC-3M-01" - 座標(30,30) - レイヤー: 0 - ハンドル: 2AA
2. "PMC-3M-02" - 座標(150,150) - レイヤー: 0 - ハンドル: 2AB

## 3. レイヤー別要素数
- レイヤー "0": 9個
- レイヤー "電気": 1個
- レイヤー "配管": 7個

## 追加情報
- 図面名: Drawing1.dwg
- 最終スキャン日時: 2025-04-06 23:55:12
```

### ユースケース3: 特定の条件に基づく要素の修正

以下のようにClaudeに指示します：

```
半径が15未満のすべての円を見つけて、それらを"小さい円"というレイヤーに移動してください
```

Claudeはデータベースクエリを使用して条件に一致する円を見つけ、それらのレイヤーを変更します。

**応答例**:
```
半径が15未満の円を検索し、"小さい円"レイヤーに移動しました。

1. まず"小さい円"レイヤーを作成しました（存在しなかったため）

2. 以下の条件でクエリを実行しました：
   "SELECT handle FROM cad_elements WHERE type = 'AcDbCircle' AND json_extract(properties, '$.radius') < 15"

3. 検索結果：
   - ハンドル "2AE": 中心(100,100)、半径10の円
   - ハンドル "2AF": 中心(300,100)、半径10の円

4. これら2つの円を"小さい円"レイヤーに移動しました。

5. データベース内の情報も更新しました。

処理が完了しました。2個の円が移動されました。
```

## 高度な使用例

### 複雑な図形の描画

以下のようにClaudeに指示します：

```
6角形を描いてください。中心は(200,200)で、各頂点は中心から50の距離にあります。
```

Claudeは数学的な計算を行い、6つの直線を使用して6角形を描画します。

**応答例**:
```
6角形を描画しました：

計算方法:
- 中心: (200, 200)
- 半径: 50
- 角度: 60度ごと（360度÷6）

頂点座標:
1. (250.0, 200.0)
2. (225.0, 243.3)
3. (175.0, 243.3)
4. (150.0, 200.0)
5. (175.0, 156.7)
6. (225.0, 156.7)

描画した線分:
1. (250.0, 200.0) → (225.0, 243.3) ハンドル: 2B2
2. (225.0, 243.3) → (175.0, 243.3) ハンドル: 2B3
3. (175.0, 243.3) → (150.0, 200.0) ハンドル: 2B4
4. (150.0, 200.0) → (175.0, 156.7) ハンドル: 2B5
5. (175.0, 156.7) → (225.0, 156.7) ハンドル: 2B6
6. (225.0, 156.7) → (250.0, 200.0) ハンドル: 2B7

すべての線はデフォルト図層に描画されています。
```

### データの分析と可視化

以下のようにClaudeに指示します：

```
図面内のすべての円の半径の分布を分析し、結果を教えてください。また、半径が平均より大きい円を赤色でハイライトしてください。
```

Claudeはデータベースから円の情報を取得し、統計分析を行い、条件に一致する円をハイライト表示します。

**応答例**:
```
図面内の円の半径分布分析:

1. 基本統計:
   - 円の総数: 4個
   - 最小半径: 10.0
   - 最大半径: 30.0
   - 平均半径: 18.75
   - 中央値: 17.5

2. 半径の分布:
   - 10.0: 2個 (50%)
   - 25.0: 1個 (25%)
   - 30.0: 1個 (25%)

3. 半径が平均(18.75)より大きい円:
   - ハンドル "2A8": 中心(50,50)、半径25.0
   - ハンドル "2A9": 中心(200,200)、半径30.0

これらの円を赤色(1)でハイライトしました。
```

### 図面の自動生成

以下のようにClaudeに指示します：

```
5x5のグリッドパターンを作成してください。各セルは50x50の正方形で、グリッドの左下の角は座標(50,50)にあります。
```

Claudeは繰り返し処理を使用して、要求されたグリッドパターンを自動生成します。

**応答例**:
```
5x5のグリッドパターンを作成しました：

1. グリッド仕様:
   - 原点: (50, 50)
   - セルサイズ: 50x50
   - グリッドサイズ: 5x5
   - 総サイズ: 250x250

2. 水平線（6本）:
   - Y=50: (50,50) → (300,50) ハンドル: 2B8
   - Y=100: (50,100) → (300,100) ハンドル: 2B9
   - Y=150: (50,150) → (300,150) ハンドル: 2BA
   - Y=200: (50,200) → (300,200) ハンドル: 2BB
   - Y=250: (50,250) → (300,250) ハンドル: 2BC
   - Y=300: (50,300) → (300,300) ハンドル: 2BD

3. 垂直線（6本）:
   - X=50: (50,50) → (50,300) ハンドル: 2BE
   - X=100: (100,50) → (100,300) ハンドル: 2BF
   - X=150: (150,50) → (150,300) ハンドル: 2C0
   - X=200: (200,50) → (200,300) ハンドル: 2C1
   - X=250: (250,50) → (250,300) ハンドル: 2C2
   - X=300: (300,50) → (300,300) ハンドル: 2C3

グリッドパターンは"グリッド"という新しいレイヤーに作成しました。
合計12本の線を描画しました。
```

## トラブルシューティング

### 一般的な問題と解決策

#### 1. AutoCADに接続できない

**症状**: 「AutoCADに接続できません」というエラーメッセージが表示される

**解決策**:
- AutoCADが起動していることを確認してください
- AutoCADを管理者権限で実行してみてください
- COM接続の権限を確認してください
- AutoCADのバージョンが2018以上であることを確認してください

**具体的な手順**:
```
1. AutoCADを一度終了し、「管理者として実行」で再起動
2. Windows Defenderファイアウォールの設定でAutoCADの通信を許可
3. AutoCADのCOMインターフェースを有効化:
   - AutoCAD内で「オプション」→「システム」→「一般」→「COMインターフェースを有効にする」にチェック
```

#### 2. ツールが見つからないエラー

**症状**: Claudeが「そのようなツールはありません」と応答する

**解決策**:
- MCPサーバーが正しく設定されていることを確認してください
- Claude Desktopを再起動してみてください
- サーバーの実行ファイルパスが正しいか確認してください

**具体的な手順**:
```
1. Claude Desktopの設定ファイルを確認:
   %APPDATA%\Claude\claude_desktop_config.json
2. サーバーが正しく起動しているか確認:
   タスクマネージャーでserver.exeまたはpython.exeプロセスを確認
3. Claude Desktopを再起動
```

#### 3. データベースエラー

**症状**: 「データベース操作に失敗しました」というエラーメッセージが表示される

**解決策**:
- データベースファイルのパーミッションを確認してください
- データベースが破損している場合は、ファイルを削除して再作成してください
- ディスク容量が十分あることを確認してください

**具体的な手順**:
```
1. autocad_data.dbファイルを探す（通常はserver.pyと同じディレクトリ）
2. ファイルが存在する場合は削除
3. サーバーを再起動して新しいデータベースを作成
4. 図面要素を再スキャン
```

#### 4. 図形が描画されない

**症状**: コマンドは成功するが、AutoCADに図形が表示されない

**解決策**:
- 座標値が有効であることを確認してください
- 現在のビューポートが適切に設定されていることを確認してください
- レイヤーが非表示になっていないか確認してください

**具体的な手順**:
```
1. AutoCADで「ZOOM」→「Extents」コマンドを実行して全体表示
2. レイヤー管理パネルを開き、すべてのレイヤーが表示されていることを確認
3. 「REGEN」コマンドを実行して図面を再生成
```

### ログの確認方法

問題が発生した場合は、コンソール出力を確認してください。サーバーを直接実行している場合は、コマンドプロンプトに詳細なログが表示されます。

**ログの確認手順**:
1. サーバーをコマンドプロンプトから直接実行している場合:
   - コマンドプロンプトウィンドウでエラーメッセージを確認

2. 実行ファイル(.exe)を使用している場合:
   - 同じディレクトリに`server.log`ファイルがあれば確認
   - なければ、一時的にログ出力を有効にして再実行:
     ```
     set AUTOCAD_MCP_DEBUG=1
     server.exe
     ```

3. Claude Desktop設定ファイルでログ出力を有効にする:
   ```json
   {
     "mcpServers": {
       "autocad-mcp-server": {
         "command": "path/to/server.exe",
         "args": [],
         "env": {
           "PYTHONIOENCODING": "utf-8",
           "AUTOCAD_MCP_DEBUG": "1"
         }
       }
     }
   }
   ```

### 高度なデバッグ

より詳細なデバッグが必要な場合は、以下の方法を試してください:

1. **Pythonデバッガーの使用**:
   ```python
   import pdb; pdb.set_trace()
   ```
   をコードの問題箇所の前に挿入し、対話的にデバッグ

2. **COM接続のテスト**:
   ```python
   import win32com.client
   try:
       acad = win32com.client.Dispatch("AutoCAD.Application")
       print("接続成功:", acad.Version)
   except Exception as e:
       print("接続失敗:", str(e))
   ```

3. **データベース整合性チェック**:
   ```
   sqlite3 autocad_data.db "PRAGMA integrity_check;"
   ```

---

このチュートリアルでは、AutoCAD MCP サーバーの基本的な使用方法から高度な使用例まで説明しました。さらに詳細な技術情報については、`TECHNICAL_GUIDE_JP.md`をご参照ください。